import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
  project: "proj_AYFkjvKe8VxQusQByJfeAKW2"
});


// uSIM FAQ 전체 - 질문/키워드/답변
const usimFAQ = [
{
    "question": "공항 수령 위치는 어디인가요?",
    "keywords": ["공항", "수령 위치", "인천공항", "김해공항", "부스"],
    "answer": "공항별 수령위치 안내 드리며, 아래의 수령 안내 링크에서도 확인 가능하세요.\n* 공항수령 위치 안내 : https://tinyurl.com/29tkdzap\n\n1. 인천공항 T1 - [출국 심사 전] Book Store 매장 (출국장 3층 8번 출구 인근)\n2. 인천공항 T2 - [출국 심사 이후] Book Store 매장 (출국장 3층 면세지역 253~254 게이트 부근)\n3. 김해국제공항 - [공항 내의 부산김해경전철 공항역 1층] 머니박스 매장\n\n☞ 당일 미수령 / 출국일 3일 이내면 취소 불가"
  },
{
    "question": "출국심사를 마친 뒤에는 유심을 받을 수 없나요?",
    "keywords": ["출국심사", "유심 수령", "출국장", "못 받음", "역사열"],
    "answer": "입국심사 이후 다시 출국장으로 이동 하시는 방법을 안내드릴게요.\n탑승 항공사 또는 여행사 카운터에 가셔서 상황을 얘기하시고, '역사열'을 요청하여 주시면 출국장으로 이동이 가능하세요.\n*역사열 (OFFLOAD) : 출국심사를 받은 승객을 다시 출국장으로 인도, 탑승동까지 갔다면 탑승동에서 메인동까지 인도하여 출국장 밖으로 인도함\n\n참고로 상품 수령 후 재입국시엔 처음 입국시와 동일한 심사 과정을 통하여 진행이 되세요."
  },
{
    "question": "한국에서도 유심을 교체할 수 있나요?",
    "keywords": ["국내", "유심 교체", "한국", "사용일", "설치"],
    "answer": ". 사용 국가에 한국이 포함된 요금제가 아니라면 국내에서는 사용 불가합니다. 사용 국가에 한국이 포함된 요금제는 국내에서 유심 교체하면 사용일이 시작되니 유의해 주시기 바랍니다.\n. 그 외의 요금제는 국내에서 유심 불량 유무 확인을 위한 교체는 가능하지만, 간혹 비정상적 사용으로 인식되어 현지에서 사용이 안되는 사례가 접수되는 경우가 있어 현지 도착해서 교체하시길 권장 드립니다.\n. 유심은 신제품으로 제공되어 보관 상의 문제(습기, 침수, 스크래치 등등) 외에는 불량 없음을 안내드립니다."
  },
{
    "question": "유심은 어떻게 사용하나요?",
    "keywords": ["유심 사용법", "장착", "교체", "전원", "설정"],
    "answer": ". 현지 도착해서 한국 유심을 탈착하고 제공드린 유심으로 교체하고 휴대폰 전원을 1~3회 정도 ON/OFF하면 사용 가능하세요"
  },
{
    "question": "다국가 요금제를 사용할 때 국가 간 이동 시 따로 설정이 필요한가요?",
    "keywords": ["다국가", "국가 이동", "요금제", "설정", "전원"],
    "answer": "국가 간의 이동시에 휴대폰 전원만 1~3회 정도 ON/OFF하면 사용 가능하세요"
  },
{
    "question": "데이터 로밍을 켜면 추가 요금이 발생하나요?",
    "keywords": ["로밍", "데이터", "ON", "추가요금", "비용"],
    "answer": ". 한국 유심을 탈착하고 제공드린 유심을 사용하는 동안에는 추가 요금 발생은 없으세요 (듀얼 유심이나 이심 휴대폰은 사용에 주의가 필요합니다.)\n\n. 현지 통신사의 제휴 네트워크에 접속되는 경우가 있는데 데이터 로밍을 활성화하지 않으면 사용이 안 되는 문제로 보다 원활한 사용을 위해서 데이터 로밍을 활성화(ON)해서 사용하시기 바랍니다.\n(단, 듀얼 유심이나 이심 겸용 휴대폰은 사용에 주의해 주세요)"
  },
{
    "question": "유심을 장착했는데 에러 메시지가 뜨거나 연결이 안 돼요",
    "keywords": ["에러", "연결 안 됨", "MMI 코드", "USSD", "실패"],
    "answer": "유심과 현지 네트워크 간의 업데이트가 원활하지 않을 때 해당 문구가 표시되며, 유심 표면의 ICCID(숫자로 표시) 번호를 카카오톡 고객센터 ID \"올텔\"로 전달주시면 현지 통신사에 고객님을 대신해서 장애 접수를 진행해 드릴게요"
  },
{
    "question": "데이터가 연결되지 않아요. 사용이 안 돼요",
    "keywords": ["데이터", "사용 안됨", "연결 오류", "네트워크", "LTE"],
    "answer": "통신사에 우선 확인한 바로는 정상 사용 상태로 확인되며, 대부분 휴대폰 설정이 맞지 않아서 발생하는 바 유심과 함께 제공해드린 사용 설명서의 '장애 해결 방법' 또는 아래 사항으로 확인해 주세요.\n\n1. 휴대폰의 데이터 로밍 옵션을 ON으로 설정(제공드린 유심을 사용하는 동안에는 추가 요금 발생 안 함)\n2. 휴대폰의 APN 정보를 요금제에 맞게 수동으로 변경해서 전원 재부팅\n▶ https://tinyurl.com/2dyj74fh\n3. 휴대폰의 네트워크 방식을 \"LTE 우선모드\"로 변경\n▶ 아이폰 : 설정 → 셀룰러 → 셀룰러 데이터 옵션 → 음성 및 데이터\n▶ 안드로이드 : 설정 → 연결 → 모바일 네트워크 → 데이터 네트워크 방식"
  },
{
    "question": "데이터 사용량은 어디서 확인할 수 있나요?",
    "keywords": ["데이터 사용량", "잔여량", "확인", "통계", "설정"],
    "answer": "대부분의 통신사에서 별도 확인 코드를 제공하지 않아서 아래의 휴대폰 메뉴에서 데이터 사용량 확인하면 되세요.\n\n☞ 아이폰: 설정 → 셀룰러 → 하단의 통계 재설정\n☞ 안드로이드: 설정 → 연결 → 데이터사용 → 모바일 데이터 사용량"
  },
{
    "question": "태국 AIS 유심 설명서대로 했는데 인증이 안 돼요",
    "keywords": ["태국", "AIS", "인증", "문자", "실패"],
    "answer": "전화번호 발신하는 휴대폰 화면을 캡쳐한 사진과 함께 유심의 ICCID / 휴대폰 모델 / 방문 도시를 알려주세요."
  },
{
    "question": "현지에서 부여된 내 전화번호는 어떻게 확인하나요?",
    "keywords": ["현지 번호", "전화번호 확인", "내 번호", "프로필", "설정"],
    "answer": "통화 가능한 요금제로 구매하셨다면 현지 번호 확인이 가능하세요.\n통신사에서 대부분 전화 번호 확인용 별도 코드를 제공하지 않아서, 휴대폰의 아래 안내드리는 메뉴 중에서 확인하면 되세요.\n. 휴대폰의 설정 - 휴대전화 정보\n. 휴대폰의 연락처 - 내 프로필"
  },
{
    "question": "현지 도착 후 유심이 작동하지 않으면 어떻게 하나요?",
    "keywords": ["현지", "유심 작동 안됨", "장애", "사용 안 됨", "연결 오류"],
    "answer": "제공해드린 사용 설명서의 '장애 해결 방법'으로 우선 확인해 주시고, 그래도 사용이 안 된다면 카카오톡 고객센터 \"올텔\"로 장애 증상과 함께 연락주시면 확인해서 조치해 드려요."
  },
{
    "question": "한국에서 걸려오는 전화나 문자를 받을 수 있나요?",
    "keywords": ["한국", "전화", "문자", "수신", "착신"],
    "answer": ". 유심이시라면, 한국유심을 탈착한 상태에서는 010 번호로 걸려오는 전화/문자 수신이 안 되세요. 제공드린 유심을 탈착하고 한국유심으로 교체해서 통화/문자 수신은 가능하나, 국내 가입 통신사의 로밍요금이 부과되니 사용에 주의가 필요합니다.\n\n이심이시라면 한국유심을 활성화(ON)해서 통화/문자 수신이 가능하나, 국내 가입 통신사의 로밍요금이 부과되니 사용에 주의가 필요합니다."
  },
{
    "question": "데이터 전용 요금제인데 통화는 어떻게 하나요?",
    "keywords": ["데이터 전용", "통화 방법", "전화", "카카오톡", "라인"],
    "answer": "(무료) 국제전화 어플이나 카카오톡, 라인 등을 사용해서 통화할 수 있으세요."
  },
{
    "question": "내 한국 번호로 전화하면 해외에 있다는 안내 음성이 나올까요?",
    "keywords": ["한국 번호", "해외 안내음", "착신", "음성", "알림"],
    "answer": "국내 가입된 통신사별로 설정이 상이해서 가입된 통신사 고객센터를 통해서 확인이 필요하세요."
  },
{
    "question": "사용 중에 데이터를 추가로 충전할 수 있나요?",
    "keywords": ["데이터 충전", "추가 데이터", "연장", "구매", "사용 중"],
    "answer": "구매 시의 성함/휴대폰 번호 끝의 4자리/유심의 ICCID(숫자로 표시)를 알려주시면 주문 내역을 확인해서 안내해 드릴게요."
  },
{
    "question": "유심 사용 일정을 변경하거나 연장할 수 있나요?",
    "keywords": ["사용 일정", "변경", "연장", "기간 조정", "추가"],
    "answer": ". 출국일 3일 전이라면 통신사에 개통 요청 전으로 사용 일정 변경 가능하세요. 3일 이내라면 통신사에 개통 요청이 접수된 상태로 사용 일정에 맞게 변경이 가능한지 확인해서 안내해 드릴게요. 만약 현지에서 사용중이시라면, 사용 만료일 최소 1일 전에 카카오톡 고객센터로 연락주시면 연장이 가능한지 확인해 드릴게요."
  },
{
    "question": "사용하지 않은 유심을 나중에 다시 사용할 수 있나요?",
    "keywords": ["미사용", "유심 보관", "다음에 사용", "재사용"],
    "answer": "유효기간은 고객센터나 카카오톡(올텔)로 연락주시면 바로 확인 가능 하십니다."
  },
{
    "question": "추가로 유심을 구매하면 배송비가 중복으로 결제되나요?",
    "keywords": ["추가 구매", "배송비", "중복 결제", "2회 결제"],
    "answer": "안내드리는 계좌 정보로 배송비 제외한 금액을 입금해 주시면 합배송(합배정)해 드릴게요."
  },

 
];

export async function callGPTWithFAQ_after_usim(userInput) {
  const faqTextBlock = usimFAQ
    .map(
      (f, i) => `#${i + 1}\nQ: ${f.question}\nK: ${f.keywords.join(', ')}\nA: ${f.answer}`
    )
    .join('\n\n');

  const messages = [
   {
  role: "system",
  content: `
당신은 해외 유심 및 포켓와이파이를 판매하는 올텔의 고객센터 상담사입니다.
고객이 입력한 질문을 친절하고 신뢰감 있게 이해하고 답변해 주세요.

- 아래는 자주 묻는 질문(FAQ)입니다. 질문에 직접적인 답변이 없더라도, 관련된 내용을 참고하거나 유추해서 도와주세요.
- 질문이 불분명하거나 정보가 부족하면, 공손하게 추가 정보를 요청하세요.
- 가능한 경우에는 고객이 원할 답을 예측해서 설명하고, 정말 필요한 경우에만 고객센터 안내를 해주세요.
- 답변은 자연스럽고 공손한 말투로 제공해 주세요.

아래는 참고용 FAQ입니다:
${faqTextBlock}
`
},
    {
      role: "user",
      content: userInput
    }
  ];

  const chat = await openai.chat.completions.create({
    model: "gpt-4o",
    messages
  });

  return chat.choices[0].message.content;
}