import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
  project: "proj_AYFkjvKe8VxQusQByJfeAKW2"
});


// uSIM FAQ 전체 - 질문/키워드/답변
const usimFAQ = [
  {
     "question": "어떤 모델에서 유심을 사용할 수 있나요? 공기계도 가능한가요?",
    keywords: ["유심", "공기계", "기기", "모델", "호환"],
    answer: ". 2016년 이후 출시된 모델은 공기계 포함해서 대부분 사용 가능하나, 정확한 확인을 위해서 가입 통신사(또는 휴대폰 제조사) 고객센터에 확인해 보시길 권장 드려요. 확인하실 때 컨트리락, 유심 보호 서비스도 해제되어 있는지 같이 확인하면 되세요.\n\n. 공기계로도 사용 가능하나, 휴대폰 제조사에 컨트리락, 유심 보호 서비스가 해제되어 있는지 확인 필요합니다."
  },
   { 
 "question": "공항에서 수령해도 배송비를 결제해야 하나요?",
    keywords: ["공항 수령", "배송비", "결제", "수령 방법"],
    answer: "공항 수령은 제휴사 매장을 통해 진행되어서 택배와 동일하게 배송비가 부과되며, 상품 페이지에도 해당 내용을 안내 중이니 참고해 주세요."
  },
{
    "question": "출국 전에 확인해야 할 사항이 있나요?",
    "keywords": ["출국 전", "준비", "컨트리락", "설정", "필수 사항"],
    "answer": "사용하실 휴대폰의 컨트리락(Country Lock), 휴대폰(유심) 보호 서비스, 데이터 로밍 차단 서비스가 해제되어 있는지 확인이 필요하며 가입 통신사(or 휴대폰 제조사) 고객센터를 통해서 확인하면 되세요."
  },
{
    "question": "다른 사람이 대신 수령해도 되나요?",
    "keywords": ["대리 수령", "가족", "지인", "대신", "수령"],
    "answer": "대리 수령도 가능하며, 공항 수령처에서 주문 시의 수령자 정보에 입력된 성함/휴대폰 번호를 얘기하고 수령하면 되세요.\nOR 실제 수령하실 분의 성함/휴대폰 번호를 알려주면 변경도 가능합니다."
  },
{
    "question": "오늘 주문하면 오늘 공항에서 수령할 수 있나요?",
    "keywords": ["당일", "공항 수령", "오늘 주문", "가능 여부"],
    "answer": "365일 연중 무휴(인천T1/인천T2, 김해공항)로 수령이 가능하며, 오전에 주문해서 당일 오후 수령도 가능합니다.\n\n주말 포함한 18시까지 주문이 접수되면 다음 날 수령도 가능하세요."
  },
{
    "question": "카카오톡이나 Gmail 같은 앱은 그대로 사용할 수 있나요?",
    "keywords": ["카카오톡", "Gmail", "앱 사용", "로그인", "인증"],
    "answer": "그대로 사용 가능합니다.\n다만 로그인 방식이 이메일이 아닌 휴대폰 번호일 경우 다시 접속해야 될 수 있습니다.(이메일 방식은 그대로 사용)"
  },
{
    "question": "핫스팟이나 테더링 기능도 사용할 수 있나요?",
    "keywords": ["핫스팟", "테더링", "인터넷 공유", "와이파이", "연결"],
    "answer": "핫스팟(테더링)은 통신사에서 기본적으로 제공되어 사용 가능하나, 일부 네트워크에서 사용이 안 될 수 있으며 해당 사항은 CS 불가하니 사용에 참고해 주세요."
  },
{
    "question": "사용일수에 맞는 요금제가 없어요. 어떻게 해야 하나요?",
    "keywords": ["사용일", "요금제 없음", "일정", "2장", "추가 구매"],
    "answer": "구매를 원하는 요금제 및 사용일수를 알려주시면 유심 1매로 사용이 가능한지 확인해 드릴게요."
  },
{
    "question": "태블릿에서도 유심 사용이 가능한가요?",
    "keywords": ["태블릿", "아이패드", "유심 사용", "기기 제한"],
    "answer": "모든 요금제는 휴대폰용으로 테블릿에서는 사용이 안 될 수 있으며 또는 사용이 되더라도 통신사의 임의로 사용 중지할 수 있어서 권장드리지 않아요."
  },
{
    "question": "데이터 소진 후 제공되는 저속 무제한 속도는 어느 정도인가요?",
    "keywords": ["저속", "무제한", "속도", "1Mbps", "소진"],
    "answer": "카카오톡 단문 대화(동영상 사진 전송 안 됨), 구글맵 정도 사용가능하며, 웹서핑 유튜브 시청 등의 사용은 안 됩니다.\n\n일부 네트워크에서는 사용이 안될 수 있으니 사용에 참고해 주세요."
  },
{
    "question": "해외에서 구매한 스마트폰도 유심 사용이 가능한가요?",
    "keywords": ["해외폰", "캐리어락", "컨트리락", "호환", "사용 가능"],
    "answer": "2016년 이후 출시된 해외 휴대폰이면 컨트리락과 캐리어락을 해제하시면 대부분 사용가능한데 보다 정확한 확인을 위해 휴대폰(or 제조사) 고객센터로 확인하시길 권장드려요."
  },
{
    "question": "듀얼심 스마트폰에서도 유심을 사용할 수 있나요?",
    "keywords": ["듀얼심", "듀얼폰", "두 개", "eSIM", "로밍"],
    "answer": "사용 가능하세요.\n다만 한국 유심(or 한국 이심)과 동시에 사용할 경우 데이터 로밍 비용이 청구될 수 있으니 사용에 유의해 주세요."
  },
{
    "question": "중국과 통화할 수 있는 요금제가 있나요?",
    "keywords": ["중국", "통화", "요금제", "홍콩 번호", "전화 가능"],
    "answer": "요금제 선택에서 \"+통화\" 옵션명이 포함된 요금제로 선택하면 되세요.\n\n상품 페이지의 중간쯤에 안내되고 있는데, 홍콩 번호가 부여되며 중국번호로 통화 가능(일행 간의 통화는 불가)하며 문자 사용은 안 되니 참고해 주세요."
  },
{
    "question": "중국에서 인증 문자 수신 가능한 요금제가 있나요?",
    "keywords": ["중국", "문자", "인증", "수신", "현지 번호"],
    "answer": "국내에서 판매 중인 요금제는 통화는 가능하나 문자 사용은 안 되세요.\n\n문자 수신이 필요하시면 중국의 현지 통신사 매장에서 신분증 등의 필요 서류를 제시하고 구매해야 되세요."
  }
];

export async function callGPTWithFAQ_before_usim(userInput) {
  const faqTextBlock = usimFAQ
    .map(
      (f, i) => `#${i + 1}\nQ: ${f.question}\nK: ${f.keywords.join(', ')}\nA: ${f.answer}`
    )
    .join('\n\n');

  const messages = [
   {
  role: "system",
  content: `
당신은 해외 유심 및 포켓와이파이를 판매하는 올텔의 고객센터 상담사입니다.
고객이 입력한 질문을 친절하고 신뢰감 있게 이해하고 답변해 주세요.

- 아래는 자주 묻는 질문(FAQ)입니다. 질문에 직접적인 답변이 없더라도, 관련된 내용을 참고하거나 유추해서 도와주세요.
- 질문이 불분명하거나 정보가 부족하면, 공손하게 추가 정보를 요청하세요.
- 가능한 경우에는 고객이 원할 답을 예측해서 설명하고, 정말 필요한 경우에만 고객센터 안내를 해주세요.
- 답변은 자연스럽고 공손한 말투로 제공해 주세요.

아래는 참고용 FAQ입니다:
${faqTextBlock}
`
},
    {
      role: "user",
      content: userInput
    }
  ];

  const chat = await openai.chat.completions.create({
    model: "gpt-4o",
    messages
  });

  return chat.choices[0].message.content;
}